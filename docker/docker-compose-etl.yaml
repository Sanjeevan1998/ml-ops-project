version: "3.8"

name: LexisRaw

volumes:
  lexisraw:

services:
  # Data Extraction (Download and Unzip from NYU Box)
  extract-data:
    container_name: etl_extract_data
    image: python:3.11
    user: root
    volumes:
      - lexisraw:/data
      - /home/cc/ml-ops-project/data-pipeline/scripts:/data-pipeline

    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "ğŸ—‚ï¸ Resetting dataset directory..."
        rm -rf raw_pdfs
        mkdir -p raw_pdfs
        cd raw_pdfs

        echo "ğŸŒ Downloading dataset from NYU Box..."
        curl -L https://nyu.box.com/shared/static/aiirowrixydy10weqxg3mmzvxdweumyy.zip -o LexisRaw.zip --verbose

        echo "ğŸ“¦ Unzipping dataset..."
        unzip -q LexisRaw.zip
        rm -f LexisRaw.zip

        echo "âœ… Data extracted to /data/raw_pdfs/"
        ls -lh /data/raw_pdfs/

 
  # Process Cases and Generate Metadata (Combined)
  processcases-and-createmetadata:
    container_name: etl_process_cases
    image: python:3.11
    user: root
    volumes:
      - lexisraw:/data
      - - /home/cc/ml-ops-project/data-pipeline:/data-pipeline
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "ğŸ“ Extracting metadata and processing cases..."
        python3 data-pipeline/scripts/process_pdfs.py
        python3 /data-pipeline/scripts/create_metadata.py
        echo "âœ… Processed cases and metadata saved."

        
  # Embedding Generation
  create-embeddings:
    container_name: etl_create_embeddings
    image: python:3.11
    user: root
    volumes:
      - lexisraw:/data
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "ğŸ”„ Generating embeddings..."
        python3 /data-pipeline/scripts/create_embeddings.py
        echo "âœ… Embeddings generated."

  # Triplet Generation
  generate-triplets:
    container_name: etl_generate_triplets
    image: python:3.11
    user: root
    volumes:
      - lexisraw:/data
    working_dir: /data
    command:
      - bash
      - -c
      - |
        set -e
        echo "ğŸ”„ Generating triplets..."
        python3 /data-pipeline/scripts/generate_triplets.py
        echo "âœ… Triplets generated."

  # Data Upload
  
  load-data:
    container_name: etl_load_data
    image: rclone/rclone:latest
    volumes:
    - lexisraw:/data
    - ~/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:ro
    environment:
      RCLONE_CONTAINER: object-store-persist-group36
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ -z "$RCLONE_CONTAINER" ]; then
          echo "ERROR: RCLONE_CONTAINER is not set"
          exit 1
        fi

        echo "ğŸš€ Uploading data to container $RCLONE_CONTAINER"
      
        rclone copy /data/raw_pdfs chi_uc:$RCLONE_CONTAINER \
        --progress \
        --transfers=32 \
        --checkers=16 \
        --multi-thread-streams=4 \
        --fast-list

        echo "âœ… Data uploaded to object store."
        echo "Listing directories in container after load stage:"
        rclone lsd chi_uc:$RCLONE_CONTAINER

